{% extends "base.html" %}

{% block title %}Importer Étudiants - UIR Présence{% endblock %}

{% block body %}
<div class="flex min-h-screen">
    {% include "admin/sidebar.html" %}

    <main class="flex-1 ml-64 p-8">
        <div class="mb-8">
            <a href="{{ url_for('admin.students') }}" class="text-primary hover:underline mb-2 inline-block">
                <i class="fas fa-arrow-left mr-2"></i>Retour
            </a>
            <h1 class="text-3xl font-bold text-primary">Importer des Étudiants</h1>
            <p class="text-gray-500">Importation massive via Excel</p>
        </div>

        <div class="card p-8 max-w-2xl">
            <div class="mb-8 p-4 bg-blue-50 rounded-lg text-sm text-blue-800">
                <p class="font-bold mb-2"><i class="fas fa-info-circle mr-2"></i>Instructions</p>
                <ul class="list-disc list-inside space-y-1">
                    <li>Le fichier doit être au format Excel (.xlsx ou .xls)</li>
                    <li>Les colonnes doivent être dans cet ordre: Email, Prénom, Nom, Matricule</li>
                    <li>La première ligne est ignorée (en-têtes)</li>
                </ul>
            </div>

            <form method="POST" enctype="multipart/form-data">

                <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-sm font-bold text-gray-700 mb-4">Destination de l'import</h3>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Département <span
                                class="text-red-500">*</span></label>
                        <select id="department_select" class="input-field" onchange="loadTracks()" required>
                            <option value="">-- Sélectionner un département --</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filière <span
                                class="text-red-500">*</span></label>
                        <select id="track_select" name="track_id" class="input-field" onchange="loadYears()" disabled
                            required>
                            <option value="">-- D'abord sélectionner un département --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Année Académique <span
                                class="text-red-500">*</span></label>
                        <select id="year_select" name="academic_year_id" class="input-field" disabled required>
                            <option value="">-- D'abord sélectionner une filière --</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fichier Excel <span
                            class="text-red-500">*</span></label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer"
                        onclick="document.getElementById('file-upload').click()">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600">Cliquez pour sélectionner un fichier</p>
                        <input type="file" id="file-upload" name="file" accept=".xlsx, .xls" class="hidden"
                            onchange="document.getElementById('file-name').textContent = this.files[0].name" required>
                        <p id="file-name" class="mt-2 text-sm text-primary font-medium"></p>
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <a href="{{ url_for('admin.students') }}" class="btn-secondary">Annuler</a>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-file-import mr-2"></i>Importer
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    async function loadTracks() {
        const deptId = document.getElementById('department_select').value;
        const trackSelect = document.getElementById('track_select');
        const yearSelect = document.getElementById('year_select');

        trackSelect.innerHTML = '<option value="">Chargement...</option>';
        trackSelect.disabled = true;
        yearSelect.innerHTML = '<option value="">-- D\'abord sélectionner une filière --</option>';
        yearSelect.disabled = true;

        if (!deptId) {
            trackSelect.innerHTML = '<option value="">-- D\'abord sélectionner un département --</option>';
            return;
        }

        try {
            const response = await fetch(`/admin/api/filter-options?type=tracks&parent_id=${deptId}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const tracks = await response.json();

            trackSelect.innerHTML = '<option value="">-- Sélectionner une filière --</option>';
            tracks.forEach(track => {
                trackSelect.innerHTML += `<option value="${track.id}">${track.name} (${track.level})</option>`;
            });
            trackSelect.disabled = false;
        } catch (e) {
            console.error('Erreur chargement filières:', e);
            trackSelect.innerHTML = '<option value="">Erreur de chargement</option>';
        }
    }

    async function loadYears() {
        const trackId = document.getElementById('track_select').value;
        const yearSelect = document.getElementById('year_select');

        yearSelect.innerHTML = '<option value="">Chargement...</option>';
        yearSelect.disabled = true;

        if (!trackId) {
            yearSelect.innerHTML = '<option value="">-- D\'abord sélectionner une filière --</option>';
            return;
        }

        try {
            const response = await fetch(`/admin/api/filter-options?type=years&parent_id=${trackId}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const years = await response.json();

            yearSelect.innerHTML = '<option value="">-- Sélectionner une année --</option>';
            years.forEach(year => {
                yearSelect.innerHTML += `<option value="${year.id}">${year.name}</option>`;
            });
            yearSelect.disabled = false;
        } catch (e) {
            console.error('Erreur chargement années:', e);
            yearSelect.innerHTML = '<option value="">Erreur de chargement</option>';
        }
    }
</script>
{% endblock %}